<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>April 2018 Blizzard â€“ Precip Type</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./leaflet.css">
<script src="./leaflet.js"></script>

<style>
html,body,#map{height:100%;margin:0}

/* ===== Banner (UNCHANGED STYLE) ===== */
.tvbanner{position:absolute;top:0;left:0;right:0;z-index:9999;
background:rgba(11,28,45,.9);color:#fff;font-family:Arial}
.banner-topline{display:flex;justify-content:center;padding:8px 12px}
.topline-center{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.top-lesson{font-size:26px;font-weight:900}
.top-question{font-size:15px;font-weight:700}
.banner-divider{height:3px;background:#eab35b}
.banner-bottomline{display:flex;justify-content:center;padding:6px}
.bottomline-center{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

.bbtn{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.4);
color:#fff;padding:8px 12px;border-radius:10px;font-weight:900;cursor:pointer}

#bannerTimeLabel{min-width:230px;text-align:center;font-weight:900}
#brandLogo{position:absolute;right:10px;bottom:-12px;width:200px;z-index:900}

.leaflet-top.leaflet-right{margin-top:90px}
</style>
</head>

<body>
<div id="map"></div>

<div class="tvbanner">
  <div class="banner-topline">
    <div class="topline-center">
      <span class="top-lesson">Lesson 1</span>
      <span>â€”</span>
      <span class="top-question">What precipitation type is occurring?</span>
    </div>
  </div>
  <div class="banner-divider"></div>
  <div class="banner-bottomline">
    <div class="bottomline-center">
      <button class="bbtn" id="bBackBtn">â—€</button>
      <div id="bannerTimeLabel"></div>
      <button class="bbtn" id="bFwdBtn">â–¶</button>
    </div>
  </div>
</div>

<img id="brandLogo" src="./logo.png">

<script>
/* ================= CONFIG ================= */
const STEP_HOURS = 3;

/* ðŸ”´ FIXED: April 13 start */
const startZ = new Date(Date.UTC(2018,3,13,12,0,0));
const endZ   = new Date(Date.UTC(2018,3,15,0,0,0));
let curZ = new Date(startZ);

/* Radar bounds */
const RADAR_BOUNDS = L.latLngBounds(
  [24,-126],
  [50,-66]
);

/* ================= MAP ================= */
const map = L.map("map",{minZoom:5,maxZoom:11})
  .setView([43.5,-96.5],6);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
  {subdomains:"abcd",maxZoom:19}
).addTo(map);

/* ================= OVERLAYS ================= */
const radarGroup = L.layerGroup().addTo(map);
const ptypeGroup = L.layerGroup();

const overlays = {
  "Composite Radar": radarGroup,
  "HRRR Precip Type": ptypeGroup
};

L.control.layers(null,overlays,{collapsed:false}).addTo(map);

let radarOverlay=null;
let ptypeLayer=null;

/* ================= HELPERS ================= */
function pad(n){return n<10?"0"+n:n}
function ymd(d){return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())}
function hm(d){return pad(d.getUTCHours())+"00"}

function radarURL(d){
  return `radar_frames/n0q_${ymd(d)}${pad(d.getUTCHours())}00.png`;
}

function ptypeURL(d){
  return `ptype_geojson/ptype_${ymd(d)}_${pad(d.getUTCHours())}00Z.geojson`;
}

function formatCentral(d){
  const c=new Date(d.getTime()-5*3600*1000);
  const hr=((c.getHours()+11)%12+1);
  return `${c.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})} ${hr}${c.getHours()>=12?"PM":"AM"}`;
}

/* ================= RADAR ================= */
function updateRadar(){
  const url=radarURL(curZ);
  const img=new Image();
  img.onload=()=>{
    if(radarOverlay) radarGroup.removeLayer(radarOverlay);
    radarOverlay=L.imageOverlay(url,RADAR_BOUNDS,{opacity:.7});
    radarGroup.addLayer(radarOverlay);
  };
  img.src=url;
}

/* ================= PRECIP TYPE ================= */
function ptypeColor(t){
  return t===1?"#2ecc71":   // rain
         t===2?"#5dade2":   // snow
         t===3?"#f4d03f":   // freezing rain
         t===4?"#af7ac5":   // sleet
         "#999";
}

function updatePtype(){
  const url=ptypeURL(curZ);
  fetch(url).then(r=>r.json()).then(gj=>{
    if(ptypeLayer) ptypeGroup.removeLayer(ptypeLayer);
    ptypeLayer=L.geoJSON(gj,{
      pointToLayer:(f,ll)=>L.circleMarker(ll,{
        radius:4,
        fillColor:ptypeColor(f.properties.ptype),
        fillOpacity:.8,
