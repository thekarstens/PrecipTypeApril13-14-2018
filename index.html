<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Apr 2018 Case Study – Radar + Alerts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./leaflet.css"/>
<script src="./leaflet.js"></script>
<script>
var storyStarted = false; // do not auto-open storyboard
</script>

<style>
html, body { height:100%; margin:0; }
  #map { height:100%; background:#fff; }

  /* Top TV-style banner */
  .tvbanner{
    position:absolute; top:0; left:0; right:0;
    z-index:99999;
    background:rgba(11,28,45,0.94);
    color:#fff;
    font:900 26px/1.1 Arial, sans-serif;
    letter-spacing:0.8px;
    padding:14px 18px;
    border-bottom:2px solid rgba(255,255,255,0.12);
    text-transform:uppercase;
    pointer-events:none;
  }

  .panel{
    position:absolute; top:70px; left:10px; z-index:9999;
    background:rgba(255,255,255,0.95);
    border:1px solid #ccc; border-radius:14px;
    padding:12px;
    font:700 12px/1.2 Arial, sans-serif;
    box-shadow: 0 2px 10px rgba(0,0,0,.10);
    min-width: 340px;
  }
  .row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .btn{
    border:1px solid #333; background:#fff; border-radius:12px;
    padding:6px 10px; cursor:pointer; font:800 12px Arial;
  }
  .btn:active{ transform: translateY(1px); }
  .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-weight:900; }
  .tiny { font:700 11px/1.2 Arial, sans-serif; opacity:.78; }

  /* Branding logo (bottom-right, small) */
  #brandLogo{
    position:absolute;
    bottom:6px;
    right:10px;
    z-index:100000;
    width:140px;
    max-width:24vw;
    height:auto;
    opacity:0.95;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.25));
    pointer-events:none;
  }

  /* Leaflet layer control nudge down below banner */
  .leaflet-top.leaflet-right { top: 70px; }

  /* Simple town label style */
  .town-label{
    background: rgba(255,255,255,0.75);
    border:1px solid rgba(0,0,0,0.25);
    padding:2px 6px;
    border-radius:10px;
    font:800 11px/1 Arial, sans-serif;
    box-shadow: 0 1px 4px rgba(0,0,0,.15);
  }

/* --- Banner layout + controls --- */
.tvbanner{height:76px;padding:10px 14px;pointer-events:auto;}
.banner-inner{height:100%;display:flex;align-items:center;gap:16px;}
.banner-title{font-size:34px;font-weight:900;letter-spacing:1px;white-space:nowrap;text-transform:uppercase;}
.banner-controls{display:flex;align-items:center;gap:10px;margin-left:10px;}
.bbtn{pointer-events:auto;border:1px solid rgba(255,255,255,0.35);background:rgba(0,0,0,0.25);color:#fff;
  padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer;line-height:1;}
.bbtn:hover{background:rgba(0,0,0,0.4);}
.btime{min-width:190px;text-align:center;font-weight:800;letter-spacing:.2px;}
.bsep{width:1px;height:26px;background:rgba(255,255,255,0.25);margin:0 4px;}

  .bzoom{font-weight:800;letter-spacing:.06em;color:#fff;opacity:.92;margin-right:8px}
.banner-actions{margin-left:auto;display:flex;align-items:center;gap:10px;}
.bstatus{margin-left:14px;white-space:nowrap;max-width:320px;overflow:hidden;text-overflow:ellipsis;
  font:800 12px/1 Arial, sans-serif;opacity:.9;}
#brandLogo{
  position:absolute;right:18px;bottom:6px;width:210px;z-index:900;pointer-events:none;
  filter: drop-shadow(0 3px 10px rgba(0,0,0,.35));
}


  /* --- layout tweaks --- */
  .leaflet-top.leaflet-right { margin-top: 90px; }   /* push layer toggles below banner */
  #brandLogo { bottom: 26px; right: 26px; }          /* nudge logo down a bit */


  /* --- Story panel (Google Sheet driven) --- */
  #storyPanel{
    position:absolute;
    top:90px;
    left:10px;
    width:390px;
    max-width:86vw;
    max-height: calc(100vh - 90px);
    overflow:auto;
    z-index:100001;
    background:rgba(255,255,255,0.97);
    border:1px solid rgba(0,0,0,0.18);
    border-radius:16px;
    box-shadow: 0 10px 28px rgba(0,0,0,.18);
    padding:12px 12px 10px 12px;
    transform: translateX(-110%);
    transition: transform 180ms ease;
  }
  #storyPanel.story-open{ transform: translateX(0); }
  .story-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .story-title{ font:900 16px/1.15 Arial, sans-serif; letter-spacing:.2px; }
  .story-close{
    border:1px solid rgba(0,0,0,.25);
    background:#fff;
    border-radius:10px;
    padding:4px 8px;
    font-weight:900;
    cursor:pointer;
  }
  .story-body{ margin-top:10px; font:700 13px/1.35 Arial, sans-serif; color:#111; }
  .story-body p{ margin:0 0 10px 0; }
  .story-media{ margin-top:10px; }
  .story-media img{ width:100%; border-radius:12px; border:1px solid rgba(0,0,0,0.12); }
  .story-media iframe{ width:100%; aspect-ratio: 16/9; border:0; border-radius:12px; }
  .story-nav{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; }
  .story-nav .btn{ flex:1; }
  #storyStep{ margin-top:8px; }
  /* Small story "stations" */
  .story-dot{
    width:10px;height:10px;border-radius:50%;
    background:rgba(30,136,229,0.95);
    border:2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,.25);
  }


/* --- Student/Teacher mode --- */
body.student-mode .leaflet-control-layers,
body.student-mode .bstatus { display:none !important; }

/* --- Banner: simple classroom layout --- */
.tvbanner{height:auto; padding:10px 14px; pointer-events:auto;}
.banner-inner{display:flex; align-items:center; gap:14px;}
.banner-left{display:flex; align-items:center; gap:12px; min-width:340px;}
.lesson-left{font:900 20px/1.05 Arial, sans-serif; letter-spacing:.6px; text-transform:uppercase; white-space:nowrap;}
.bbtn-story{font:900 14px/1 Arial, sans-serif; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.10);}
.bbtn-story:hover{background:rgba(255,255,255,0.18);}
.banner-mid{display:flex; align-items:center; gap:10px;}
.btime{min-width:230px; text-align:center; font:900 14px/1 Arial, sans-serif; letter-spacing:.3px;}
.banner-right{margin-left:auto; display:flex; align-items:center; gap:10px;}
.product-right{font:900 32px/1 Arial, sans-serif; letter-spacing:1px; text-transform:uppercase; padding-left:10px; border-left:1px solid rgba(255,255,255,0.25);}
.legend-mini{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:rgba(0,0,0,0.18);}
.leg-mini-label{font:900 11px/1 Arial, sans-serif; opacity:.92; text-transform:uppercase; letter-spacing:.4px;}
.leg-mini-bar{display:inline-block; width:110px; height:10px; border-radius:6px; background: linear-gradient(90deg, #2b83ba, #4ecdc4, #a8e6a3, #ffd166, #ef476f); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18);}
.opacity-wrap{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.25); background:rgba(0,0,0,0.18);}
.op-label{font:900 11px/1 Arial, sans-serif; opacity:.92; text-transform:uppercase; letter-spacing:.4px;}
#radarOpacity{width:120px;}
.bstatus{margin-top:6px; font:800 12px/1 Arial, sans-serif; opacity:.9; max-width:95vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

/* Make story button obvious */
#beginStoryBtn{border-color: rgba(255,255,255,0.45); flex:0 0 auto; margin-left:auto;}
/* --- Driving question line (option 2 style) --- */
.dq-sub{margin-top:4px;font:800 14px/1 Arial,sans-serif;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dq-label{font-weight:900;opacity:.95}
.dq-text{font-weight:900;opacity:1}

/* --- Begin story: big + obvious (yellow) --- */
.bbtn-story{
  background:#fdd835 !important;
  color:#111 !important;
  border-color: rgba(0,0,0,0.35) !important;
  font:900 14px/1 Arial,sans-serif !important;
  padding:12px 14px !important;
  border-radius:14px !important;
  letter-spacing:.8px !important;
}
.bbtn-story:hover{filter:brightness(0.96)}

/* --- Product center --- */
.banner-product{display:flex;align-items:center;justify-content:center;min-width:240px}
.product-center{
  font:900 42px/1 Arial,sans-serif;
  letter-spacing:1px;
  text-transform:uppercase;
  padding:0 10px;
  white-space:nowrap;
}

/* Logo down a bit */
#brandLogo{bottom:6px !important; right:26px !important;}

/* --- Option-2 style driving question block --- */
.banner-left{display:flex;flex-direction:column;gap:2px;min-width:420px;max-width:44vw}
.lesson-left{font:900 24px/1 Arial,sans-serif;letter-spacing:.6px;text-transform:uppercase}
.dq-sub{font:800 14px/1.2 Arial,sans-serif;letter-spacing:.2px;text-transform:none;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dq-label{font-weight:900;text-transform:uppercase;letter-spacing:.5px}
.dq-text{font-weight:800}


/* Stack Begin Story above time controls */
.story-time-stack{display:flex;flex-direction:column;gap:8px;align-items:center;min-width:210px}
.banner-mid-stack{gap:10px}
/* Give the product a little breathing room */
.banner-product{margin:0 6px}


/* --- Banner alignment fix: pull legend/controls back up --- */
.banner-inner{align-items:flex-start}
.legend-mini{margin-top:0}
.opacity-wrap{margin-top:0}
.story-time-stack{margin-top:0}


/* --- Right-side controls pinned upper-right --- */
.right-controls{
  display:flex;
  align-items:center;
  gap:10px;
  margin-left:auto;
  margin-top:0;
}


/* --- Restore "like before" banner geometry --- */
.banner-inner{position:relative; align-items:center !important;}
.right-controls{
  position:absolute;
  top:10px;
  right:14px;
  margin-left:0 !important;
  align-items:center;
}
.legend-mini, .opacity-wrap{margin-top:0 !important;}
.story-time-stack{margin-top:0 !important;}

/* Logo lower */
#brandLogo{bottom:0px !important;}

/* --- Two-line banner layout --- */
.tvbanner{
  position:absolute; top:0; left:0; right:0;
  z-index:99999;
  background:rgba(11,28,45,0.90);
  color:#fff;
  border-bottom:2px solid rgba(255,255,255,0.12);
}
.banner-topline{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:10px 14px 6px 14px;
  font-family: Arial, sans-serif;
  text-transform:uppercase;
  letter-spacing:.7px;
}
.topline-center{
  display:flex;
  flex:1 1 auto;
  min-width:0;
  align-items:baseline;
  gap:10px;
  max-width:1200px;
  width:100%;
  justify-content:flex-start;
  flex-wrap:wrap;
}
.top-lesson{font-weight:900;font-size:26px;white-space:nowrap}
.top-sep{opacity:.65;font-weight:900}
.top-question{font-weight:800;font-size:16px;letter-spacing:.2px;text-transform:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;flex:1 1 100%;text-align:center}
.top-q-label{font-weight:900;text-transform:uppercase;letter-spacing:.6px}

.banner-bottomline{
  display:flex;
  justify-content:center;
  padding:6px 14px 10px 14px;
  font-family: Arial, sans-serif;
}
.bottomline-center{
  display:flex;
  align-items:center;
  gap:12px;
  width:100%;
  max-width:1200px;
  justify-content:center;
  flex-wrap:wrap;
}
/* Big product word, flexible */
.banner-product{min-width:200px;display:flex;justify-content:center}
.product-center{
  font:900 44px/1 Arial,sans-serif;
  letter-spacing:1px;
  text-transform:uppercase;
  white-space:nowrap;
}
.time-controls{display:flex;align-items:center;gap:10px}
.btime{font:900 16px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase;white-space:nowrap}

/* Begin button */
.bbtn-story{
  background:#fdd835 !important;
  color:#111 !important;
  border-color: rgba(0,0,0,0.35) !important;
  font:900 14px/1 Arial,sans-serif !important;
  padding:12px 16px !important;
  border-radius:14px !important;
  letter-spacing:.8px !important;
}

/* Opacity group */
.opacity-wrap{display:flex;align-items:center;gap:8px}
.op-label{font:900 12px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase}
#radarOpacity{width:180px}

/* Map legend near logo */
.map-legend{
  position:absolute;
  right:190px;
  bottom:26px;
  z-index:900;
  background:rgba(11,28,45,0.80);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:12px;
  padding:8px 10px;
  color:#fff;
  font-family: Arial, sans-serif;
}
.map-legend-row{display:flex;align-items:center;gap:10px}
.leg-mini-label{font:900 12px/1 Arial,sans-serif;letter-spacing:.7px;text-transform:uppercase;opacity:.95}
.leg-mini-bar{
  width:140px;height:10px;border-radius:7px;
  background:linear-gradient(90deg,#2b83ba,#ffd166,#ef476f);
}

/* Keep logo low */
#brandLogo{bottom:0px !important; right:26px !important;}

/* --- Brand color stripes (from Weather Workshops logo) --- */
.tvbanner{ position:absolute; }
.tvbanner::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height:4px;
  background:#2f4e94;
}
.tvbanner{position:absolute; top:0; left:0; right:0; z-index:99999; }


.banner-topline{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  padding:14px 14px 8px 14px;
  font-family: Arial, sans-serif;
  text-transform:uppercase;
  letter-spacing:.7px;
  position:relative;
}
.banner-topline .topline-center{
  flex:1;
  display:flex;
  align-items:baseline;
  gap:10px;
  max-width:1200px;
  justify-content:center;
  flex-wrap:wrap;
  padding-right:190px; /* reserve space so button doesn't overlap text */
}
.banner-topline .bbtn-story{
  position:absolute;
  right:14px;
  top:10px;
}


.banner-bottomline{padding:6px 14px 12px 14px;}


.map-legend{
  right:12px !important;
  bottom:70px !important;
  padding:7px 9px !important;
  border-radius:12px !important;
}
.leg-mini-bar{width:120px !important;}


#brandLogo{bottom:0px !important; right:14px !important;}


/* Pin START button in top-right of the top banner line */
.banner-topline{position:relative !important;}
.banner-topline > .bbtn-story{
  position:absolute !important;
  right:14px !important;
  top:10px !important;
}


/* Orange divider line in the middle (between top line and controls line) */
.banner-divider{
  height:3px;
  width:100%;
  background:#eab35b; /* brand orange */
  opacity:0.95;
}


/* Nudge legend tighter into the corner */
.map-legend{right:10px !important; bottom:62px !important;}


/* Center lesson/question text */
.topline-center{
  justify-content:center !important;
  text-align:center !important;
}

/* Force START button to upper-right corner */
.banner-topline{
  position:relative !important;
}
.banner-topline .bbtn-story{
  position:absolute !important;
  right:16px !important;
  top:50% !important;
  transform:translateY(-50%) !important;
}


/* --- FINAL banner alignment fixes --- */

/* True center for top line text */
.banner-topline{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
}
.banner-topline .topline-center{
  margin:0 auto !important;
  text-align:center !important;
  padding-right:0 !important;
}

/* Force START button to true upper-right corner */
.banner-topline .bbtn-story{
  position:absolute !important;
  right:16px !important;
  top:12px !important;
  transform:none !important;
}

/* Center RADAR on second row */
.banner-bottomline{
  display:flex !important;
  justify-content:center !important;
}
.banner-product{
  margin:0 auto !important;
}
.product-center{
  text-align:center !important;
}


/* --- Pin START button to upper-right (top line) --- */
.banner-topline{position:relative !important;}
.banner-topline #beginStoryBtn{
  position:absolute !important;
  right:16px !important;
  top:10px !important;
  transform:none !important;
}

/* --- Push logo slightly LOWER than the bottom edge (so it "sits lower") --- */
#brandLogo{
  bottom:-12px !important;
  right:10px !important;
}


/* Slightly tighter banner height (small) */
.banner-topline{padding-top:8px !important; padding-bottom:5px !important;}
.banner-bottomline{padding-top:3px !important; padding-bottom:7px !important;}


/* --- Slight banner shrink (top text + controls) --- */
.top-lesson{font-size:22px !important;}
.top-question{font-size:14px !important;}
.product-center{font-size:38px !important;}
.bbtn{padding:7px 10px !important; font-size:12px !important;}
.bbtn-story{padding:10px 14px !important; font-size:13px !important;}
#radarOpacity{width:160px !important;}
.banner-topline{padding-top:7px !important; padding-bottom:4px !important;}
.banner-bottomline{padding-top:2px !important; padding-bottom:6px !important;}


/* --- Brand logo: smaller + lower --- */
#brandLogo{
  width:150px !important;
  height:auto !important;
  bottom:-24px !important;
  right:10px !important;
  opacity:0.95 !important;
}


/* TV-style city labels */
.leaflet-tooltip.tv-city-label{
  background:rgba(255,255,255,0.94);
  color:#111;
  border:0;
  border-radius:10px;
  padding:4px 8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.25);
  font:800 12px/1 Arial,sans-serif;
}
.leaflet-tooltip-top.tv-city-label:before,
.leaflet-tooltip-right.tv-city-label:before,
.leaflet-tooltip-left.tv-city-label:before,
.leaflet-tooltip-bottom.tv-city-label:before{
  border:0;
}


  /* Ensure popups/tooltips render above boundary lines pane */
  .leaflet-tooltip-pane { z-index: 1200 !important; }
  .leaflet-popup-pane   { z-index: 1300 !important; }

  /* HRRR pixel-query popup styling (bigger, bolder for students) */
  .hrrr-popup .leaflet-popup-content-wrapper{
    border-radius: 14px;
    border: 2px solid rgba(0,0,0,0.35);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }
  .hrrr-popup .leaflet-popup-content{
    margin: 12px 14px;
    font: 900 18px/1.15 Arial, sans-serif;
    letter-spacing: 0.2px;
  }

</style>
</head>

<body>
<div id="map"></div>
<div id="mapLegend" class="map-legend" title="Radar reflectivity">
  <div class="map-legend-row">
    <span class="leg-mini-label">Light</span>
    <span class="leg-mini-bar" aria-hidden="true"></span>
    <span class="leg-mini-label">Heavy</span>
  </div>
</div>
<div id="storyPanel" aria-label="Story panel">
  <div class="story-head">
    <div class="story-title" id="storyTitle">Story</div>
    <button class="story-close" id="storyCloseBtn" title="Close">✕</button>
  </div>
  <div class="story-body" id="storyBody">
    <p class="tiny">Loading story…</p>
  </div>
  <div class="story-nav">
    <button class="btn" id="storyPrevBtn">Back</button>
    <button class="btn" id="storyNextBtn">Next</button>
  </div>
  <div class="tiny" id="storyStep"></div>
</div>
<div id="banner" class="tvbanner">
  <div class="banner-topline" role="banner">
    <div class="topline-center">
      <span class="top-lesson">Lesson 1: Driving Question</span>
      <span class="top-sep">—</span>
      <span class="top-question"><span class="top-q-label">Question:</span> How can we use real-time weather data to make safer decisions?</span>
    </div>
    <button class="bbtn bbtn-story" id="beginStoryBtn" title="Begin the guided story">START</button>
  </div>
  <div class="banner-divider" aria-hidden="true"></div>

  <div class="banner-bottomline">
    <div class="bottomline-center">
<button class="bbtn" id="modeBtn" title="Toggle Student / Teacher mode">STUDENT</button>

      <div class="opacity-wrap" title="Radar opacity">
        <span class="op-label">Opacity</span>
        <input id="radarOpacity" type="range" min="20" max="100" value="70" />
      </div>

      <div class="banner-product" aria-label="Product shown">
        <div class="product-center" id="productLabel">RADAR</div>
      </div>

      <div class="time-controls" aria-label="Time controls">
        <button class="bbtn" id="bBackBtn" title="Back 3 hours">◀</button>
        <div class="btime" id="bannerTimeLabel">April 14, 2018 7AM</div>
        <button class="bbtn" id="bFwdBtn" title="Forward 3 hours">▶</button>
      </div>

      <button class="bbtn" id="zoomOutBtn" title="Zoom out">−</button>
      <button class="bbtn" id="zoomInBtn" title="Zoom in">+</button>
    </div>
  </div>

  <div id="status" class="bstatus" style="display:none;"></div>
</div>

<img id="brandLogo" src="./logo.png" alt="Weather Workshops" />
<script>
(function(){
  // ---------- Config ----------
  var STEP_HOURS = 3;

  // Use the same starting time as your case study controls:
  // Time window for the time controls (expanded to include earlier GFS forecast frames).
  var startZ = new Date(Date.UTC(2018, 3, 11, 0, 0, 0));  // 2018-04-11 00Z (earliest GFS frames we may use)
  var endZ   = new Date(Date.UTC(2018, 3, 15, 12, 0, 0)); // 2018-04-15 12Z (storm end window; extend later if needed) // 24h window; extend later if you want
  var curZ = new Date(startZ.getTime());

  // Composite radar geographic extent (NAD83 geographic). Shifted ~60mi south + ~15mi east for better fit.
  // Base extent commonly used by IEM mosaics: lon -126..-66, lat 24..50
  var SHIFT_LAT = -1.09; // south shift (~15mi extra)   // south
  var SHIFT_LON = 0.49; // east shift (~15mi extra)   // east
  var RADAR_BOUNDS = L.latLngBounds(
    L.latLng(24 + SHIFT_LAT, -126 + SHIFT_LON),
    L.latLng(50 + SHIFT_LAT,  -66 + SHIFT_LON)
  );

  // Local file pattern in your repo:
  // radar_frames/n0q_201804141200.png, etc
  function pad2(n){ return (n<10?'0':'') + n; }
  function yyyymmdd(d){
    return d.getUTCFullYear() + pad2(d.getUTCMonth()+1) + pad2(d.getUTCDate());
  }
  function hhmm(d){
    return pad2(d.getUTCHours()) + pad2(d.getUTCMinutes());
  }
  function radarUrlFor(d){
    return "radar_frames/n0q_" + yyyymmdd(d) + hhmm(d) + ".png";
  }

  // GFS snow forecast PNGs in repo (static frames)
  // gfs_snow/gfs_20180411_00z_f96_snow_weatherbell.png
  // gfs_snow/gfs_20180412_00z_f72_snow_weatherbell.png
  // gfs_snow/gfs_20180413_00z_f48_snow_weatherbell.png
  function gfsSnowUrlFor(d){
    // Pick the most-relevant static forecast image for the current time.
    // (We don't animate this yet; we just swap between a few key lead times.)
    var t = d.getTime();
    var t13 = Date.UTC(2018,3,13,0,0,0); // Apr 13 00Z
    var t12 = Date.UTC(2018,3,12,0,0,0); // Apr 12 00Z
    if (t >= t13) return "gfs_snow/gfs_20180413_00z_f48_snow_weatherbell.png";
    if (t >= t12) return "gfs_snow/gfs_20180412_00z_f72_snow_weatherbell.png";
    return "gfs_snow/gfs_20180411_00z_f96_snow_weatherbell.png";
  }

  // Alerts file pattern you already have:
  // timeline_hourly/alerts_20180414_1500Z.geojson
  function alertsUrlFor(d){
    return "timeline_hourly/alerts_" + yyyymmdd(d) + "_" + pad2(d.getUTCHours()) + "00Z.geojson";
  }

  // "Central time" label (forced) — we just subtract 5 hours and show CST
  // (Technically CDT for April, but your students don't need DST complexity here.)
  function formatCentralLabel(d) {
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const m = months[d.getMonth()];
  const day = d.getDate();
  const year = d.getFullYear();
  let hr = d.getHours();
  const ampm = hr >= 12 ? "PM" : "AM";
  hr = hr % 12; if (hr === 0) hr = 12;
  // e.g. "Apr 14, 2018 7AM"
  return `${m} ${day}, ${year} ${hr}${ampm}`;
}

  // ---------- Map ----------
  var map = L.map("map", { zoomControl:true }).setView([43.55, -96.73], 6);

  // --- State boundaries / outlines (GeoJSON first; tile fallback) ---
  map.createPane("lines");
  map.getPane("lines").style.zIndex = 450;         // above dots, below popups         // above dots
  map.getPane("lines").style.pointerEvents = "none"; // keep clicks working

  var usStatesLayer = null;
  var usStatesLoaded = false;

  // Fallback: reliable reference tiles (works even if GeoJSON isn't present)
  var stateLinesTile = L.tileLayer(
    "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}",
    { pane: "lines", opacity: 0.95 }
  );

  function loadUsStatesGeoJSONOnce(){
    if (usStatesLoaded) return;
    usStatesLoaded = true;

    fetch("gz_2010_us_040_00_5m.json?v="+Date.now())
      .then(function(res){
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(function(geojson){
        usStatesLayer = L.geoJSON(geojson, {
          pane: "lines",
          style: function(){
            return { color:"#000000", weight: 1.2, opacity: 0.95, fillOpacity: 0 };
          }
        });
        // If user already has HRRR temp on, add immediately
        if (typeof hrrrTempLayer !== "undefined" && map.hasLayer(hrrrTempLayer)) addStateLines();
      })
      .catch(function(err){
        // If GeoJSON missing, we just rely on tile fallback
        console.log("State GeoJSON not loaded (using tile fallback):", err);
      });
  }

  function addStateLines(){
    // Prefer GeoJSON outlines if available; otherwise tile fallback
    if (usStatesLayer) {
      if (!map.hasLayer(usStatesLayer)) usStatesLayer.addTo(map);
      if (map.hasLayer(stateLinesTile)) map.removeLayer(stateLinesTile);
    } else {
      if (!map.hasLayer(stateLinesTile)) stateLinesTile.addTo(map);
    }
  }
  function removeStateLines(){
    if (usStatesLayer && map.hasLayer(usStatesLayer)) map.removeLayer(usStatesLayer);
    if (map.hasLayer(stateLinesTile)) map.removeLayer(stateLinesTile);
  }

  // Kick off loading in the background (won't break anything if missing)
  loadUsStatesGeoJSONOnce();
  // Clean base map (no labels)
  var base = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png",
    { attribution: "&copy; OpenStreetMap &copy; CARTO", subdomains:"abcd", maxZoom: 19 }
  ).addTo(map);

  
  // --- Extra Midwest city labels (shows more as you zoom in) ---
  var cityLabelLayer = L.layerGroup().addTo(map);

  function makeCityLabel(name, lat, lon){
    return L.marker([lat, lon], {
      interactive: false,
      icon: L.divIcon({
        className: "town-label",
        html: name,
        iconSize: null
      })
    });
  }

  var CITIES_TIER1 = [
    ["Sioux Falls", 43.5446, -96.7311],
    ["Minneapolis", 44.9778, -93.2650],
    ["Des Moines", 41.5868, -93.6250],
    ["Omaha", 41.2565, -95.9345],
    ["Kansas City", 39.0997, -94.5786],
    ["Rapid City", 44.0805, -103.2310],
    ["Denver", 39.7392, -104.9903]
  ];

  var CITIES_TIER2 = [
    ["Fargo", 46.8772, -96.7898],
    ["Bismarck", 46.8083, -100.7837],
    ["Pierre", 44.3683, -100.3510],
    ["Brookings", 44.3114, -96.7984],
    ["Watertown", 44.8994, -97.1150],
    ["Rochester", 44.0121, -92.4802],
    ["Sioux City", 42.4990, -96.4003],
    ["Lincoln", 40.8136, -96.7026],
    ["St. Louis", 38.6270, -90.1994],
    ["Madison", 43.0731, -89.4012],
    ["Milwaukee", 43.0389, -87.9065],
    ["Chicago", 41.8781, -87.6298]
  ];

  function updateCityLabels(){
    var z = map.getZoom();
    cityLabelLayer.clearLayers();

    if (z >= 4){
      CITIES_TIER1.forEach(function(c){ cityLabelLayer.addLayer(makeCityLabel(c[0], c[1], c[2])); });
    }
    if (z >= 6){
      CITIES_TIER2.forEach(function(c){ cityLabelLayer.addLayer(makeCityLabel(c[0], c[1], c[2])); });
    }
  }
  map.on("zoomend", updateCityLabels);
  updateCityLabels();

// Optional labels (kept on top to help students)
  var labels = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png",
    { attribution: "", subdomains:"abcd", maxZoom: 19, pane: "overlayPane" }
  ).addTo(map);

  // Town labels
  function addTown(name, lat, lon){
    L.marker([lat, lon], {
      icon: L.divIcon({ className:"town-label", html: name, iconSize: null }),
      interactive:false
    }).addTo(map);
  }
addTown("Omaha", 41.2565, -95.9345);
  addTown("Des Moines", 41.5868, -93.6250);
  addTown("Minneapolis", 44.9778, -93.2650);
  addTown("Kansas City", 39.0997, -94.5786);
  addTown("St. Louis", 38.6270, -90.1994);


  // ---------- Story (Google Sheet) ----------
  var SHEET_ID = "17Hzg7R2fSHJGbOKAKMqG4QAqA1GlSJwFM-SQwPhQObY";
  var SHEET_TAB = "April Blizzard Story";
  var storyItems = [];
  var storyMarkers = [];
  var storyIndex = 0;
  var focusRing = null;

  var storyPanel = document.getElementById("storyPanel");
  var storyTitleEl = document.getElementById("storyTitle");
  var storyBodyEl  = document.getElementById("storyBody");
  var storyStepEl  = document.getElementById("storyStep");

  function storyOpen(){
    if (!storyPanel) return; storyPanel.classList.add("story-open");
    var legendPop = document.getElementById("legendPop");
    if (legendPop) legendPop.classList.add("hidden");
    setTimeout(function(){ map.invalidateSize(); }, 220);
  }
  function storyClose(){
    if (!storyPanel) return; storyPanel.classList.remove("story-open");
    setTimeout(function(){ map.invalidateSize(); }, 220);
  }
  function storyToggle(){
    if (storyPanel.classList.contains("story-open")) storyClose();
    else if (storyStarted) { storyOpen(); }
  }

  function safeLink(url){
    if (!url) return "";
    return String(url).trim();
  }

  function renderStory(i, panTo){
    if (!storyItems.length) return;
    if (i < 0) i = 0;
    if (i >= storyItems.length) i = storyItems.length - 1;
    storyIndex = i;

    var item = storyItems[storyIndex];
    storyTitleEl.textContent = item.title || "Storm Story";

    var html = "";
    if (item.text) {
      // Convert newlines to paragraphs
      var parts = String(item.text).split(/\n+/).filter(Boolean);
      parts.forEach(function(p){ html += "<p>" + escapeHtml(p) + "</p>"; });
    } else {
      html += "<p class='tiny'>No text for this station yet.</p>";
    }

    var img = safeLink(item.image);
    var vid = safeLink(item.video);

    if (img) {
      html += "<div class='story-media'><img src='" + img + "' alt='Story image'></div>";
    }
    if (vid) {
      // Prefer embed links (youtube embed, vimeo embed, etc.)
      html += "<div class='story-media'><iframe src='" + vid + "' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe></div>";
    }

    storyBodyEl.innerHTML = html;
    storyStepEl.textContent = "Station " + (storyIndex + 1) + " of " + storyItems.length;

    // Highlight markers
    storyMarkers.forEach(function(m, idx){
      if (m && m.setStyle) {
        m.setStyle({
          radius: (idx===storyIndex? 12 : 8),
          opacity: 1,
          fillOpacity: (idx===storyIndex? 1 : 0.9),
          weight: (idx===storyIndex? 3 : 2)
        });
        if (idx===storyIndex && m.bringToFront) m.bringToFront();
      }
    });

    // Focus ring around the active station (helps guide attention)
    if (typeof item.lat === "number" && typeof item.lon === "number") {
      var ringRadiusM = 22000; // ~14 miles
      if (!focusRing) {
        focusRing = L.circle([item.lat, item.lon], {
          radius: ringRadiusM,
          color: "rgba(30,136,229,0.95)",
          weight: 2,
          opacity: 0.95,
          fill: false,
          dashArray: "6 6"
        }).addTo(map);
      } else {
        focusRing.setLatLng([item.lat, item.lon]);
        focusRing.setRadius(ringRadiusM);
      }
      if (focusRing.bringToFront) focusRing.bringToFront();
    }

    if (storyStarted) { storyOpen(); }

    if (panTo && item.lat != null && item.lon != null) {
      map.panTo([item.lat, item.lon], { animate:true });
    }
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function buildStoryMarkers(){
    // Remove existing
    storyMarkers.forEach(function(m){ try{ map.removeLayer(m); }catch(e){} });
    storyMarkers = [];

    storyItems.forEach(function(item, idx){
      if (typeof item.lat !== "number" || typeof item.lon !== "number") return;

      var m = L.circleMarker([item.lat, item.lon], {
        radius: 8,
        color: "rgba(255,255,255,0.95)",
        weight: 2,
        fillColor: "rgba(30,136,229,0.95)",
        fillOpacity: 0.9
      }).addTo(map);

      m.on("click", function(){
        renderStory(idx, false);
      });

      // Short hover tooltip
      if (item.title) {
        m.bindTooltip(item.title, { direction:"top", offset:[0,-8], opacity:0.9 });
      }

      storyMarkers.push(m);
    });

    // Initial highlight
    renderStory(0, false);
  }

  function loadStory(){
    var url = "https://opensheet.elk.sh/" + SHEET_ID + "/" + encodeURIComponent(SHEET_TAB);
    fetch(url).then(function(r){
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }).then(function(rows){
      // Normalize rows
      storyItems = (rows || []).map(function(r){
        var lat = parseFloat(r.lat);
        var lon = parseFloat(r.lon);
        return {
          id: r.id,
          title: r.title || "",
          text: r.text || "",
          lat: isFinite(lat) ? lat : null,
          lon: isFinite(lon) ? lon : null,
          image: r.image || "",
          video: r.video || "",
          order: parseFloat(r.order)
        };
      })
      .filter(function(x){ return x.title || x.text || (x.lat!=null && x.lon!=null); })
      .sort(function(a,b){
        var ao = isFinite(a.order) ? a.order : 9999;
        var bo = isFinite(b.order) ? b.order : 9999;
        return ao - bo;
      });

      if (!storyItems.length) {
        storyBodyEl.innerHTML = "<p class='tiny'>No rows found in your Google Sheet tab '" + SHEET_TAB + "'.</p>";
        return;
      }

      buildStoryMarkers();
      setStatus("Story: loaded " + storyItems.length + " stations");
    }).catch(function(err){
      storyBodyEl.innerHTML = "<p class='tiny'>Could not load story from Google Sheet. Check that the sheet is published, and the tab name is '" + SHEET_TAB + "'.</p>";
      setStatus("Story load failed");
    });
  }

  
// Banner actions
var beginStoryBtn = document.getElementById("beginStoryBtn");
if (beginStoryBtn) beginStoryBtn.onclick = function(){ storyStarted = true;
    renderStory(storyIndex, true); };

// Student/Teacher mode (Student hides layer toggles + status)
var modeBtn = document.getElementById("modeBtn");
function setMode(mode){
  if (mode === "teacher"){
    document.body.classList.remove("student-mode");
    if (modeBtn) modeBtn.textContent = "TEACHER";
  } else {
    document.body.classList.add("student-mode");
    if (modeBtn) modeBtn.textContent = "STUDENT";
  }
}
if (modeBtn){
  modeBtn.onclick = function(){
    var isStudent = document.body.classList.contains("student-mode");
    setMode(isStudent ? "teacher" : "student");
  };
}
// default to STUDENT mode
setMode("student");

// Opacity slider (applies to the currently visible product)
var radarOpacity = document.getElementById("radarOpacity");

// Remember per-layer opacity so kids can flip products without losing their setting
var productOpacity = { radar: 0.70, snow: 0.70, temp: 0.70 };

function getActiveProductKey(){
  // Priority: snow > temp > radar (matches your product label logic)
  if (typeof gfsSnowEnabled !== "undefined" && gfsSnowEnabled) return "snow";
  if (typeof hrrrTempLayer !== "undefined" && map.hasLayer(hrrrTempLayer)) return "temp";
  return "radar";
}

function setTempOpacity(op){
  if (!hrrrTempGeo) return;
  // base halo is softer, core is stronger
  var baseOp = Math.max(0.10, Math.min(0.85, op * 0.55));
  var coreOp = Math.max(0.20, Math.min(1.00, op));

  hrrrTempGeo.eachLayer(function(layerOrGroup){
    if (layerOrGroup && layerOrGroup.eachLayer){
      layerOrGroup.eachLayer(function(l){
        if (!l || !l.setStyle) return;
        var role = (l.options && l.options._role) ? l.options._role : "core";
        l.setStyle({ fillOpacity: (role === "base") ? baseOp : coreOp });
      });
    }
  });
}

function applyActiveOpacity(){
  if (!radarOpacity) return;
  var v = parseInt(radarOpacity.value || "70", 10);
  var op = Math.max(0.2, Math.min(1, v/100));

  var key = getActiveProductKey();
  productOpacity[key] = op;

  if (key === "radar"){
    if (obsRadarOverlay && obsRadarEnabled) obsRadarOverlay.setOpacity(op);
  } else if (key === "snow"){
    if (gfsSnowOverlay && gfsSnowEnabled) gfsSnowOverlay.setOpacity(op);
  } else if (key === "temp"){
    setTempOpacity(op);
  }
}

function syncOpacitySliderToActive(){
  if (!radarOpacity) return;
  var key = getActiveProductKey();
  radarOpacity.value = Math.round((productOpacity[key] || 0.7) * 100);
}

// Wire slider
if (radarOpacity){
  radarOpacity.oninput = applyActiveOpacity;
}


  // Story UI buttons

  
  var storyCloseBtn = document.getElementById("storyCloseBtn");
  if (storyCloseBtn) storyCloseBtn.onclick = storyClose;

  var prevBtn = document.getElementById("storyPrevBtn");
  var nextBtn = document.getElementById("storyNextBtn");
  if (prevBtn) prevBtn.onclick = function(){ renderStory(storyIndex - 1, true); };
  if (nextBtn) nextBtn.onclick = function(){ renderStory(storyIndex + 1, true); };

  // Load story now
  loadStory();


  map.on("zoomend", function(){
    var zl = document.getElementById("zoomLabel"); if (zl) zl.textContent = map.getZoom();
  });

  // Keep HRRR temp blobs sized appropriately as you zoom
  map.on("zoomend", updateHrrrTempRadius);


  map.on("click", function(e){
    var lp = document.getElementById("legendPop");
    if (lp) lp.classList.add("hidden");

    // Pixel query (click) for HRRR temp: show nearest grid point value
    if (!map.hasLayer(hrrrTempLayer)) return;
    if (!hrrrPoints || hrrrPoints.length === 0) return;

    var lat = e.latlng.lat, lon = e.latlng.lng;
    var best = null, bestD = Infinity;
    var coslat = Math.cos(lat * Math.PI/180);

    for (var i=0; i<hrrrPoints.length; i++){
      var p = hrrrPoints[i];
      var dlat = (p.lat - lat);
      var dlon = (p.lon - lon) * coslat;
      var d2 = dlat*dlat + dlon*dlon;
      if (d2 < bestD){ bestD = d2; best = p; }
    }
    if (!best) return;

    var val = Math.round(best.tF); // whole degrees
    L.popup({
      className: "hrrr-popup",
      autoPan: false,
      closeButton: false,
      pane: "popupPane",
      offset: [0, -10]
    })
    .setLatLng([best.lat, best.lon])
    .setContent(val + "°F")
    .openOn(map);
  });

  // ---------- Layers ----------
  var obsRadarOverlay = null;
  var obsRadarEnabled = true;

  // GFS Snow Forecast overlay (static PNG swapper)
  var gfsSnowOverlay = null;
  var gfsSnowEnabled = false;

  var alertsLayer = L.geoJSON(null, {
    filter: function(f){
      const p = (f && f.properties) ? f.properties : {};
      const ev = String(p.event || p.EVENT || p.headline || p.HEADLINE || "").toLowerCase();
      const phe = String(p.phenomena || p.PHENOM || p.phenom || "").toLowerCase();
      const sig = String(p.significance || p.SIG || p.sig || "").toLowerCase();

      // If we have human-readable event text, keep WARNINGS only
      if (ev){
        if (ev.includes("statement") || ev.includes("advisory") || ev.includes("watch")) return false;
        return ev.includes("warning");
      }

      // If data uses NWS-style codes, keep significance=W (warning)
      // Examples: phe=sv,to,ff,fl with sig=w
      if (sig === "w") return true;

      return false;
    },

    
    style: function(f){
      var p = (f && f.properties) ? f.properties : {};
      var ev = String(p.event || p.EVENT || p.headline || p.phenomena || "").toLowerCase();
      var phe = String(p.phenomena || p.PHENOM || "").toLowerCase();
      var sig = String(p.significance || p.SIG || "").toLowerCase();

      // Prefer explicit event text if present
      var key = ev || (phe && sig ? (phe + "." + sig) : phe || "");

      var stroke = "#333";
      var fill = "#333";

      var has = function(s){ return key.indexOf(s) !== -1; };

      // Core colors requested
      if (has("tornado") || phe==="to") { stroke = fill = "#e53935"; }          // red
      else if (has("severe thunderstorm") || phe==="sv") { stroke = fill = "#fdd835"; } // yellow
      else if (has("flash flood") || phe==="ff") { stroke = fill = "#00c853"; } // green
      else if (has("flood") || phe==="fl") { stroke = fill = "#00c853"; }       // green
      else { stroke = fill = "#42a5f5"; } // fallback blue

      return { color: stroke, weight: 2, opacity: 0.95, fillColor: fill, fillOpacity: 0.22 };
    },
    onEachFeature: function(f, layer){
      var props = f.properties || {};
      var title = props.event || props.EVENT || props.headline || props.HEADLINE || props.prod_type || props.phenomena || "Warning";
      layer.bindPopup("<b>" + String(title) + "</b>");
    }
  });
  alertsLayer.addTo(map);
  var alertsEnabled = true;

  // Layer control (NO extra base layer picker)
  // State boundary outline handled via GeoJSON (no labels)
var overlays = {};
  overlays["Composite Radar (Observed)"] = L.layerGroup(); // placeholder group

  overlays["GFS Snow Forecast"] = L.layerGroup(); // checkbox only; overlay managed manually

  // HRRR Temp GeoJSON (real layer group; Leaflet handles show/hide)
  var hrrrTempLayer = L.layerGroup();
  overlays["HRRR Temp (2m)"] = hrrrTempLayer;


// --- HRRR TEMP "blob map" styling helpers (Option 1) ---
var hrrrTempGeo = null;
var hrrrPoints = []; // [{lat, lon, tF}] for pixel query
var hrrrCanvas = L.canvas({ padding: 0.5 });

function lerp(a,b,t){ return a + (b-a)*t; }
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

// Smooth color ramp for temperature (F)
function hexToRgb(hex){
  hex = hex.replace("#","");
  if (hex.length===3){ hex = hex.split("").map(c=>c+c).join(""); }
  var n = parseInt(hex,16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}
function rgbToCss(c){ return "rgb(" + c.r + "," + c.g + "," + c.b + ")"; }
function mix(c1,c2,t){
  return { r: Math.round(lerp(c1.r,c2.r,t)), g: Math.round(lerp(c1.g,c2.g,t)), b: Math.round(lerp(c1.b,c2.b,t)) };
}

// Smooth, WeatherBell-style temperature ramp (°F)
// Anchors: 20s deep blue -> 30s lighter blue -> 40s dark green -> 50s light green -> 60s yellow -> 70s orange -> 80s red -> 90s magenta
var TEMP_STOPS = [
  // WeatherBell-ish temperature ramp (°F): purples -> blues -> cyans -> greens -> yellows -> oranges -> reds -> pinks
  {t:-30, c:"#3b0a5e"},
  {t:-20, c:"#54278f"},
  {t:-10, c:"#1f3f9a"},
  {t:  0, c:"#08519c"},
  {t: 10, c:"#3182bd"},
  {t: 20, c:"#6baed6"},
  {t: 30, c:"#41b6c4"},
  {t: 40, c:"#1a9850"},
  {t: 50, c:"#66bd63"},
  {t: 60, c:"#d9ef8b"},
  {t: 70, c:"#fee08b"},
  {t: 80, c:"#fdae61"},
  {t: 90, c:"#f46d43"},
  {t:100, c:"#d73027"},
  {t:110, c:"#c51b8a"},
  {t:120, c:"#7a0177"}
].map(s => ({ t:s.t, c: hexToRgb(s.c) }));



function tempColor(tF){
  if (!isFinite(tF)) return "rgba(0,0,0,0)";
  // Clamp into range
  tF = clamp(tF, TEMP_STOPS[0].t, TEMP_STOPS[TEMP_STOPS.length-1].t);
  // Find bracketing stops
  for (var i=0; i<TEMP_STOPS.length-1; i++){
    var a = TEMP_STOPS[i], b = TEMP_STOPS[i+1];
    if (tF >= a.t && tF <= b.t){
      var tt = (tF - a.t) / (b.t - a.t);
      // Slight gamma curve to boost contrast around gradients
      tt = Math.pow(tt, 0.70);
      return rgbToCss(mix(a.c, b.c, tt));
    }
  }
  return rgbToCss(TEMP_STOPS[TEMP_STOPS.length-1].c);
}

function radiusForZoom(z){
  // Bigger dots as you zoom in (kids can “see the field” without tiny gaps).
  // Tuned for ~3 km HRRR spacing: overlap at mid-zooms, and get BIG at local zooms.
  if (z <= 4)  return 22;
  if (z <= 5)  return 26;
  if (z <= 6)  return 30;
  if (z <= 7)  return 34;
  if (z <= 8)  return 40;
  if (z <= 9)  return 48;
  if (z <= 10) return 58;
  if (z <= 11) return 70;
  return 82; // z>=12
}

function updateHrrrTempRadius(){
  if (!hrrrTempGeo) return;

  var z = map.getZoom();
  var r = radiusForZoom(z);

  hrrrTempGeo.eachLayer(function(layerOrGroup){
    // Each feature returns a LayerGroup [base, core]
    if (layerOrGroup && layerOrGroup.eachLayer){
      layerOrGroup.eachLayer(function(l){
        if (!l || !l.setRadius) return;
        var role = (l.options && l.options._role) ? l.options._role : "base";
        l.setRadius(role === "base" ? r : Math.max(2, Math.round(r * 0.22)));
      });
    } else if (layerOrGroup && layerOrGroup.setRadius){
      layerOrGroup.setRadius(r);
    }
  });
}
  // Load once (GeoJSON must be in same folder as this index.html)
  fetch("./hrrr_t2m_20180414_12z_f00.geojson")
    .then(function(r){ if(!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(function(gj){
      hrrrTempGeo = L.geoJSON(gj, {
        // IMPORTANT: convert 0..360 longitudes -> -180..180 for Leaflet
        coordsToLatLng: function(coords){
          var lon = coords[0], lat = coords[1];
          if (lon > 180) lon = lon - 360;
          return L.latLng(lat, lon);
        },
        
pointToLayer: function(feature, latlng){
  var t = Number(feature.properties && feature.properties.t_f);
  var r = radiusForZoom(map.getZoom());
  var c = tempColor(t);

  // Base "blob" for gradient field
  var base = L.circleMarker(latlng, {
    renderer: hrrrCanvas,
    radius: r,
    weight: 0,
    fillColor: c,
    fillOpacity: 0.35,
    _role: "base"
  });

  // Core dot for "sample point" feel (kept subtle so it doesn't look too polka-dot)
  var core = L.circleMarker(latlng, {
    renderer: hrrrCanvas,
    radius: Math.max(2, Math.round(r * 0.18)),
    weight: 0,
    fillColor: c,
    fillOpacity: 0.55,
    _role: "core"
  });

  var grp = L.layerGroup([base, core]);
  // stash references so we can resize + bind tooltips correctly
  grp._base = base;
  grp._core = core;
  if (isFinite(t)) { hrrrPoints.push({lat: latlng.lat, lon: latlng.lng, tF: t}); }
  return grp;
},
        onEachFeature: function(feature, layer){
          var t = (feature.properties && feature.properties.t_f != null) ? Number(feature.properties.t_f).toFixed(1) : "NA";
          if (layer && layer._core && layer._core.bindTooltip){
            layer._core.bindTooltip(t + "°F", { sticky: true });
          } else if (layer && layer.bindTooltip){
            layer.bindTooltip(t + "°F", { sticky: true });
          }
        }
      }).addTo(hrrrTempLayer);
      // If HRRR layer is currently visible, show state boundaries too
      if (map.hasLayer(hrrrTempLayer)) { addStateLines(); }
      updateHrrrTempRadius();
    })
    .catch(function(err){ console.log("HRRR temp load failed:", err); });

// We'll manage radar ourselves but still expose a checkbox
  var lc = L.control.layers(null, overlays, { collapsed:false }).addTo(map);

  // Remove any base-layer radio section if Leaflet created it empty
  setTimeout(function(){
    var el = document.querySelector(".leaflet-control-layers-base");
    if (el) el.style.display = "none";
  }, 50);

  // Reliable layer toggle handling (Leaflet provides e.layer, not e.name)
  
  function enforceSingleOverlay(layerAdded){
    // Only one of the main products at a time (RADAR, SNOW, TEMP).
    // State lines are driven by TEMP and are not part of this exclusivity.
    var mainLayers = [
      overlays["Composite Radar (Observed)"],
      overlays["GFS Snow Forecast"],
      hrrrTempLayer
    ];

    for (var i=0;i<mainLayers.length;i++){
      var LYR = mainLayers[i];
      if (!LYR) continue;
      if (LYR === layerAdded) continue;
      if (map.hasLayer(LYR)) map.removeLayer(LYR);
    }

    // Also ensure radar/snow overlays clean up if their checkbox was turned off by us
    if (!map.hasLayer(overlays["Composite Radar (Observed)"])){
      obsRadarEnabled = false;
      if (obsRadarOverlay) map.removeLayer(obsRadarOverlay);
    }
    if (!map.hasLayer(overlays["GFS Snow Forecast"])){
      gfsSnowEnabled = false;
      if (gfsSnowOverlay) map.removeLayer(gfsSnowOverlay);
    }
  }
map.on("overlayadd", function(e){
    enforceSingleOverlay(e.layer);
    if (e.layer === overlays["Composite Radar (Observed)"]) { obsRadarEnabled = true; updateRadar(); updateProductLabel(); }
    if (e.layer === overlays["GFS Snow Forecast"]) { gfsSnowEnabled = true; updateGfsSnow(); updateProductLabel(); }
    if (e.layer === hrrrTempLayer) {
      addStateLines();
      updateProductLabel();
      updateHrrrTempRadius();
    }
  
    syncOpacitySliderToActive();
    applyActiveOpacity();
    updateLegend();
});
  map.on("overlayremove", function(e){
    if (e.layer === overlays["Composite Radar (Observed)"]) { obsRadarEnabled = false; if (obsRadarOverlay){ map.removeLayer(obsRadarOverlay); } updateProductLabel(); }
    if (e.layer === overlays["GFS Snow Forecast"]) { gfsSnowEnabled = false; if (gfsSnowOverlay){ map.removeLayer(gfsSnowOverlay); } updateProductLabel(); }
    if (e.layer === hrrrTempLayer) {
      removeStateLines();
      updateProductLabel();
    }
  });

  // Ensure radar checkbox starts ON
  // Leaflet doesn't automatically check our placeholder group, so we force it:
  (function forceRadarChecked(){
    var inputs = document.querySelectorAll(".leaflet-control-layers-overlays input");
    for (var i=0;i<inputs.length;i++){
      var label = inputs[i].parentElement && inputs[i].parentElement.textContent || "";
      if (label.indexOf("Composite Radar") !== -1){
        inputs[i].checked = true;
      }
    }
  })();
  // Sync UI for default layer
  syncOpacitySliderToActive();
  applyActiveOpacity();
  updateLegend();

  // ---------- Updaters ----------
  function setStatus(s){ /* hidden */ }
  function setTimeLabel(){
    document.getElementById("bannerTimeLabel").textContent = formatCentralLabel(curZ);
  }

  function updateProductLabel(){
  var pl = document.getElementById("productLabel");
  if (!pl) return;

  // IMPORTANT: never concatenate labels (it will crowd the middle).
  // Choose ONE label based on what is currently visible/active.
  var candidates = [
    { on: (typeof gfsSnowEnabled !== "undefined" && gfsSnowEnabled), label: "SNOW" },
    { on: (typeof ptypeEnabled  !== "undefined" && ptypeEnabled),  label: "P-TYPE" },
    { on: (typeof hrrrTempLayer !== "undefined" && map.hasLayer(hrrrTempLayer)), label: "TEMP" },
    { on: (typeof obsRadarEnabled !== "undefined" && obsRadarEnabled), label: "RADAR" }
  ];

  var label = "MAP";
  for (var i=0;i<candidates.length;i++){
    if (candidates[i].on){ label = candidates[i].label; break; }
  }
  pl.textContent = label;
}
  function updateLegend(){
    var el = document.getElementById("mapLegend");
    if (!el) return;
    var bar = el.querySelector(".leg-mini-bar");
    var title = "";

    var key = getActiveProductKey();
    if (key === "radar"){
      title = "Radar reflectivity";
      if (bar) bar.style.background = "linear-gradient(90deg, #2b83ba, #4ecdc4, #a8e6a3, #ffd166, #ef476f)";
      el.style.display = "";
    } else if (key === "snow"){
      title = "Snow (forecast)";
      if (bar) bar.style.background = "linear-gradient(90deg, #ffffff, #d7ecff, #9ac8ff, #4f7cff)";
      el.style.display = "";
    } else { // temp
      title = "2m Temperature (°F)";
      // WeatherBell-ish continuous temp ramp (cold blues -> greens -> yellows -> oranges -> reds -> purples)
      if (bar) bar.style.background = "linear-gradient(90deg, #0b2e83 0%, #1f66d3 15%, #6fb7ff 28%, #1f8a3a 42%, #7fe36d 52%, #ffe14a 63%, #ff9a1f 73%, #e31a1c 82%, #a4007c 92%, #ff66ff 100%)";
      el.style.display = "";
    }

    el.title = title;
  }


  function updateRadar(){
    if (!obsRadarEnabled) return;
    var url = radarUrlFor(curZ);

    // Test-load the image before swapping overlay (avoids blank overlay on 404)
    var img = new Image();
    img.onload = function(){
      if (obsRadarOverlay){ map.removeLayer(obsRadarOverlay); }
      var op = 0.70; var rs = document.getElementById("radarOpacity"); if (rs){ op = Math.max(0.2, Math.min(1, parseInt(rs.value||"70",10)/100)); }
      obsRadarOverlay = L.imageOverlay(url, RADAR_BOUNDS, { opacity: op, interactive:false });
      obsRadarOverlay.addTo(map);
      applyActiveOpacity();
      setStatus("Radar: " + url);
    };
    img.onerror = function(){
      setStatus("Radar missing: " + url + " (check /radar_frames/)");
    };
    img.src = url;
  }

  
  function updateGfsSnow(){
    if (!gfsSnowEnabled) return;

    var url = gfsSnowUrlFor(curZ);

    // Preload to avoid flashing broken images
    var img = new Image();
    img.onload = function(){
      if (gfsSnowOverlay){ map.removeLayer(gfsSnowOverlay); }
      // Use same bounds as the rest of the CONUS layers for consistent alignment
      gfsSnowOverlay = L.imageOverlay(url, RADAR_BOUNDS, { opacity: 0.75, interactive: false });
      gfsSnowOverlay.addTo(map);
      setStatus("GFS Snow: " + url);
    };
    img.onerror = function(){
      setStatus("GFS Snow missing: " + url + " (check /gfs_snow/)");
    };
    img.src = url;
  }

function updateAlerts(){
    
    var url = alertsUrlFor(curZ);
    fetch(url).then(function(r){
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }).then(function(gj){
      alertsLayer.clearLayers();
      alertsLayer.addData(gj);
      alertsLayer.addTo(map);
      setStatus("Alerts: " + url);
    }).catch(function(err){
      alertsLayer.clearLayers();
      setStatus("Alerts missing: " + url);
    });
  }

  function updateAll(){
    setTimeLabel();
    updateRadar();
    updateGfsSnow();
    updateAlerts();
    updateProductLabel();
  }

  // ---------- Time controls ----------
  function clampTime(){
    if (curZ < startZ) curZ = new Date(startZ.getTime());
    if (curZ > endZ) curZ = new Date(endZ.getTime());
  }

  document.getElementById('bBackBtn').onclick = function(){
    curZ = new Date(curZ.getTime() - STEP_HOURS*3600*1000);
    clampTime(); updateAll();
  };
  document.getElementById('bFwdBtn').onclick = function(){
    curZ = new Date(curZ.getTime() + STEP_HOURS*3600*1000);
    clampTime(); updateAll();
  };

  const zIn = document.getElementById("zoomInBtn");
  const zOut = document.getElementById("zoomOutBtn");
  if (zIn) zIn.onclick = () => map.zoomIn();
  if (zOut) zOut.onclick = () => map.zoomOut();


  // Initial
  setTimeLabel();
  // Add overlays based on default checkboxes
  // Alerts starts OFF; radar starts ON.
  updateAll();

})();
</script>
</body>
</html>